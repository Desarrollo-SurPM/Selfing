{% extends 'base.html' %}

{% block title %}Vista Previa del Correo{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="h3 mb-4"><i class="fas fa-eye me-2"></i>Vista Previa del Correo de Novedades</h2>

    <div class="card shadow-sm">
        <div class="card-header">
            <h4>Para: <strong>{{ company.name }}</strong></h4>
        </div>
        <div class="card-body">
            <p class="text-muted">Revisa el contenido del correo antes de enviarlo. Puedes editar las novedades en la pantalla anterior si es necesario.</p>

            <div class="email-content-preview border p-3 rounded bg-light">
                <h5 class="text-primary">Asunto: Reporte de Novedades - {{ company.name }} - {{ cycle_end|date:"d/m/Y" }}</h5>
                <hr>
                <p>Estimado cliente <strong>{{ company.name }}</strong>,</p>
                <p>A continuaci√≥n, se detallan las novedades del ciclo de turnos (del {{ cycle_start|date:"d/m/Y H:i" }} hrs al {{ cycle_end|date:"d/m/Y H:i" }} hrs):</p>

                {% regroup updates by installation.name as installation_list %}
                {% for installation in installation_list %}
                    <div style="margin-top: 15px;">
                        <h6 style="color: #2a5298; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong>{{ installation.grouper }}:</strong>
                        </h6>
                        <div style="font-size: 0.9em; line-height: 1.6; padding-left: 10px;">
                            {% for update in installation.list %}
                                <p style="margin: 0;">
                                    <strong>
                                        {% if update.manual_timestamp %}
                                            {{ update.manual_timestamp|time:"H:i" }} {{ update.created_at|date:"d/m" }}
                                        {% else %}
                                            {{ update.created_at|date:"H:i d/m" }}
                                        {% endif %}
                                    </strong> - {{ update.message }}
                                </p>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}

                {% if observations %}
                    <div style="margin-top: 20px;">
                        <h6 style="color: #1e3c72;"><strong>Observaciones Generales:</strong></h6>
                        <div style="background-color: #eaf2f8; padding: 10px; border-left: 4px solid #2a5298; border-radius: 4px;">
                            <p style="margin: 0;">{{ observations|linebreaksbr }}</p>
                        </div>
                    </div>
                {% endif %}
            </div>

            <form method="post" action="{% url 'review_and_send_novedades' %}" class="mt-4">
                {% csrf_token %}
                <input type="hidden" name="company_id" value="{{ company.id }}">
                <input type="hidden" name="observations" value="{{ observations }}">
                {% for update_id in selected_ids %}
                <input type="hidden" name="updates_to_send" value="{{ update_id }}">
                {% endfor %}
                <input type="hidden" name="confirm_send" value="true">

                <div class="d-flex justify-content-end">
                    <a href="{% url 'review_and_send_novedades' %}?company_id={{ company.id }}" class="btn btn-secondary me-2">
                        <i class="fas fa-edit me-2"></i>Editar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Confirmar y Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}