{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Empresas Cliente{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/manage_pages.css' %}?v=1.5">
    <link rel="stylesheet" href="{% static 'css/color_theme.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    {# ================= Encabezado de la Página ================= #}
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-building"></i> Gestión de Empresas Cliente</h2>
                <p>Administra las empresas y sus instalaciones</p>
            </div>
            <a href="{% url 'create_company' %}" class="btn btn-add">
                <i class="fas fa-plus-circle"></i> Añadir Empresa
            </a>
        </div>
    </div>

    {# ================= Tarjetas de Estadísticas ================= #}
    <div class="stats-row">
        <div class="stat-card total">
            <i class="fas fa-city"></i>
            <div class="stat-value">{{ companies.count }}</div>
            <div class="stat-label">Total Empresas</div>
        </div>
        <div class="stat-card active">
            <i class="fas fa-map-marked-alt"></i>
            <div class="stat-value">{{ total_installations }}</div>
            <div class="stat-label">Total Instalaciones</div>
        </div>
    </div>
    
    {# ================= Barra de Búsqueda y Filtros ================= #}
    <div class="toolbar">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por nombre de empresa o email...">
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                {# Aquí puedes añadir filtros si los necesitas en el futuro #}
            </div>
        </div>
    </div>

    {# ================= Tabla de Empresas ================= #}
    <div class="table-container">
        <table class="table" id="companiesTable">
            <thead>
                <tr>
                    <th>Empresa</th>
                    <th>Contacto</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for company in companies %}
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="background: {% cycle 'linear-gradient(135deg, #4e73df, #224abe)' 'linear-gradient(135deg, #1cc88a, #17a673)' 'linear-gradient(135deg, #36b9cc, #2c9faf)' 'linear-gradient(135deg, #f6c23e, #dda20a)' 'linear-gradient(135deg, #e74a3b, #c0392b)' 'linear-gradient(135deg, #9b59b6, #8e44ad)' 'linear-gradient(135deg, #fd7e14, #e8590c)' 'linear-gradient(135deg, #20c997, #1ba085)' 'linear-gradient(135deg, #6f42c1, #59359a)' 'linear-gradient(135deg, #dc3545, #c82333)' %}; color: white; border: 2px solid {% cycle '#4e73df' '#1cc88a' '#36b9cc' '#f6c23e' '#e74a3b' '#9b59b6' '#fd7e14' '#20c997' '#6f42c1' '#dc3545' %};">{{ company.name|first|upper }}</div>
                            <div class="user-details">
                                <div class="username" style="color: {% cycle '#4e73df' '#1cc88a' '#36b9cc' '#f6c23e' '#e74a3b' '#9b59b6' '#fd7e14' '#20c997' '#6f42c1' '#dc3545' %}; font-weight: 600;">{{ company.name }}</div>
                                <div class="role">{{ company.installations.count }} Instalaciones</div>
                            </div>
                        </div>
                    </td>
                    
                    {# ===== BLOQUE CORREGIDO CON JAVASCRIPT ===== #}
                    <td id="email-cell-{{ company.id }}">
                        <script>
                            (function() {
                                const emailString = "{{ company.email|default:'' }}";
                                const cell = document.getElementById('email-cell-{{ company.id }}');

                                if (emailString) {
                                    const emails = emailString.split(',').map(e => e.trim()).filter(e => e);
                                    let html = '';

                                    if (emails.length > 0) {
                                        html += `
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-envelope me-2 text-muted"></i>
                                                <a href="mailto:${emails[0]}" class="text-decoration-none text-dark">${emails[0]}</a>
                                        `;

                                        if (emails.length > 1) {
                                            html += `
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                        +${emails.length - 1}
                                                    </button>
                                                    <ul class="dropdown-menu">`;
                                            
                                            for (let i = 1; i < emails.length; i++) {
                                                html += `<li><a class="dropdown-item" href="mailto:${emails[i]}">${emails[i]}</a></li>`;
                                            }
                                            
                                            html += `</ul></div>`;
                                        }
                                        html += `</div>`;
                                    }
                                    cell.innerHTML = html;
                                } else {
                                    cell.innerHTML = '<span class="text-muted">Sin email registrado</span>';
                                }
                            })();
                        </script>
                    </td>
                    {# ===== FIN DEL BLOQUE CORREGIDO ===== #}

                    <td class="text-center">
                        <div class="action-buttons justify-content-center">
                            <a href="{% url 'manage_installations' company.id %}" class="btn-action" style="background-color: rgba(78, 115, 223, 0.1); color: #4e73df;" title="Ver Instalaciones">
                                <i class="fas fa-map-marked-alt"></i>
                            </a>
                            <a href="{% url 'edit_company' company.id %}" class="btn-action btn-edit" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'delete_company' company.id %}" class="btn-action btn-delete" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">
                        <div class="empty-state">
                            <i class="fas fa-building"></i>
                            <h4>No hay empresas registradas</h4>
                            <p>Comienza agregando la primera empresa cliente al sistema.</p>
                            <a href="{% url 'create_company' %}" class="btn btn-add mt-3">
                                <i class="fas fa-plus-circle"></i> Añadir Primera Empresa
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-back">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
    </div>

</div>

{# Script para la funcionalidad de búsqueda #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const tableRows = document.querySelectorAll('#companiesTable tbody tr');

    searchInput.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        
        tableRows.forEach(row => {
            if (row.querySelector('.empty-state')) return;

            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}