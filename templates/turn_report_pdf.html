{% load static %}
{% load duration_filters %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Reporte de Turno - SELFING</title>
    <style>
        /* --- AJUSTES GLOBALES --- */
        @page { 
            size: a4 portrait; 
            margin: 1.5cm; /* Margen optimizado */
        }
        
        body { 
            font-family: "Helvetica", "Arial", sans-serif; 
            font-size: 10pt; /* Letra base ligeramente m√°s grande para legibilidad */
            color: #000; 
            line-height: 1.4;
        }
        
        /* --- ESTILOS DEL FORMATO ORIGINAL (CON PEQUE√ëOS AJUSTES) --- */
        .document-container { background-color: white; border: 2px solid #333; padding: 20px; min-height: 90vh; }
        .header { text-align: center; border: 2px solid #000; background-color: #e8e8e8; padding: 15px; margin-bottom: 20px; }
        .header h1 { margin: 0 0 5px 0; font-size: 16pt; font-weight: bold; text-transform: uppercase; }
        .header .subtitle { font-size: 12pt; margin: 0; font-weight: normal; }
        .operator-info { border: 2px solid #000; background-color: #e8e8e8; padding: 15px; margin: 20px 0; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { padding: 10px 12px; border: 2px solid #333; vertical-align: middle; text-align: center; font-size: 11pt; }
        .info-label { background-color: #d0d0d0; font-weight: bold; width: 25%; }
        .info-value { background-color: #f8f8f8; width: 25%; font-weight: 500; }
        .section { border: 2px solid #000; background-color: #e8e8e8; padding: 15px; margin: 20px 0; page-break-inside: avoid; }
        .section-header { background-color: #d0d0d0; border: 1px solid #000; color: #000; padding: 10px 15px; margin: -15px -15px 15px -15px; font-size: 12pt; font-weight: bold; text-align: center; text-transform: uppercase; }
        .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; background: white; border: 2px solid #000; }
        
        /* --- üëá CAMBIO: Padding reducido para tablas m√°s compactas üëá --- */
        .data-table th, .data-table td { padding: 6px 8px; border: 2px solid #000; } 
        .data-table th { background: #d0d0d0; font-weight: bold; text-align: center; }
        .data-table td { vertical-align: top; background-color: #f8f8f8; }
        .data-table tr:nth-child(even) td { background: #f5f5f5; }

        .company-section { margin: 15px 0; border: 2px solid #333; background-color: #f5f5f5; }
        .company-title { background-color: #e0e0e0; padding: 8px 12px; margin: 0; border-bottom: 2px solid #333; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .installation-block { margin: 12px; border: 1px solid #666; background-color: #f8f8f8; }
        .installation-name { background-color: #ddd; padding: 6px 10px; margin: 0; border-bottom: 1px solid #666; font-size: 11px; font-weight: bold; }
        .item-list { padding: 10px; }
        .no-data { text-align: center; color: #000; font-style: italic; padding: 15px; background: white; border: 1px solid #000; margin: 10px 0; }
        .footer { position: fixed; bottom: 1cm; left: 1.5cm; right: 1.5cm; text-align: center; font-size: 9pt; color: #000; border-top: 1px solid #000; padding-top: 10px; }
        .log-entry { display: block; padding: 4px 8px; font-size: 10pt; } /* Letra de bit√°cora un poco m√°s grande */
    </style>
</head>
<body>
    <div class="document-container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                <img src="{% static 'images/Logo.png' %}" alt="SELFING Logo" style="height: 40px; margin-right: 15px;">
                <h1 style="margin: 0;">REPORTE DE TURNO</h1>
            </div>
            <p class="subtitle">Sistema de Gesti√≥n Operacional - SELFING</p>
        </div>
        <div class="operator-info">
            <table class="info-table">
                <tr>
                    <td class="info-label">Operador:</td>
                    <td class="info-value">{{ operator.get_full_name|default:operator.username }}</td>
                    <td class="info-label">Duraci√≥n Total:</td>
                    <td class="info-value">{{ duration }}</td>
                </tr>
                <tr>
                    <td class="info-label">Inicio de Turno:</td>
                    <td class="info-value">{{ start_time|date:"d/m/Y H:i" }}</td>
                    <td class="info-label">Fin de Turno:</td>
                    <td class="info-value">{{ end_time|date:"d/m/Y H:i" }}</td>
                </tr>
            </table>
        </div>

        <div class="section">
            <div class="section-header">BIT√ÅCORA DE EVENTOS</div>
            {% if updates_log %}
                {% regroup updates_log by installation.company.name as company_list %}
                {% for company in company_list %}
                    <div class="company-section">
                        <div class="company-title">{{ company.grouper }}</div>
                        {% regroup company.list by installation.name as installation_list %}
                        {% for installation in installation_list %}
                            <div class="installation-block">
                                <div class="installation-name">üìç {{ installation.grouper }}</div>
                                <div class="item-list">
                                    {% for update in installation.list %}
                                        <div class="log-entry">
                                            <strong>
                                                {% if update.manual_timestamp %}{{ update.manual_timestamp|date:"H:i" }} hrs*{% else %}{{ update.created_at|date:"H:i" }} hrs{% endif %}
                                            </strong> - <span>{{ update.message }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data">‚ÑπÔ∏è No se registraron eventos durante este turno</div>
            {% endif %}
        </div>
        
        <div class="section">
            <div class="section-header">RONDAS VIRTUALES REALIZADAS</div>
            {% if rondas_virtuales %}
                <table class="data-table">
                    <thead><tr><th>Ronda</th><th>Hora Inicio</th><th>Hora Fin</th><th>Duraci√≥n</th></tr></thead>
                    <tbody>
                        {% for ronda in rondas_virtuales %}
                        <tr>
                            <td><strong>Ronda {{ forloop.counter }}</strong></td>
                            <td>{{ ronda.start_time|date:"H:i:s" }}</td>
                            <td>{{ ronda.end_time|date:"H:i:s" }}</td>
                            <td>{{ ronda.duration_seconds|format_duration }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="no-data">No se realizaron rondas virtuales en este turno</div>
            {% endif %}
        </div>

        <div class="section">
            <div class="section-header">CHECKLIST COMPLETADO</div>
            {% if checklist_by_phase %}
                {% for phase_key, phase_data in checklist_by_phase.items %}
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 4px solid {% if phase_key == 'start' %}#28a745{% elif phase_key == 'during' %}#007bff{% else %}#dc3545{% endif %};">
                            {{ phase_data.display_name }}
                        </h4>
                        <table class="data-table" style="margin-bottom: 15px;">
                            <thead><tr><th>Hora</th><th>Descripci√≥n</th><th>Observaci√≥n</th></tr></thead>
                            <tbody>
                                {% for log in phase_data.logs %}
                                    <tr>
                                        <td><strong>{{ log.completed_at|date:"H:i" }}</strong></td>
                                        <td>{{ log.item.description }}</td>
                                        <td>{{ log.observacion|default:"‚Äî" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data">No se completaron tareas del checklist en este turno</div>
            {% endif %}
        </div>

        <div class="footer">
            Reporte generado el {{ current_time|date:"d/m/Y H:i" }} - Sistema SELFING
        </div>
    </div>
</body>
</html>