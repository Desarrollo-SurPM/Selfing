{% extends 'base.html' %}
{% load static %}

{% block title %}Seguridad Vehicular - SELFING{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/color_theme.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .vehicle-dashboard {
            padding: 20px;
        }
        .map-container {
            height: 550px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        #vehicleMap {
            height: 100%;
            width: 100%;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            min-width: 200px;
        }
        .map-controls h6 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            color: #2d3436;
        }
        .control-group {
            margin-bottom: 8px;
        }
        .control-group label {
            display: flex;
            align-items: center;
            font-size: 0.8em;
            margin: 0;
            cursor: pointer;
        }
        .control-group input[type="checkbox"] {
            margin-right: 8px;
        }
        .weather-popup {
            max-width: 250px;
        }
        .weather-popup .weather-icon {
            font-size: 2em;
            text-align: center;
            margin-bottom: 10px;
        }
        .speed-alert {
            background: #ff6b6b;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .weather-alert {
            background: #ffa726;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .stats-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .weather-widgets-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .weather-widget {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
            position: relative;
        }
        .weather-widget.santiago { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .weather-widget.punta_arenas { background: linear-gradient(135deg, #00b894, #00a085); }
        .weather-widget.valparaiso { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .weather-widget.concepcion { background: linear-gradient(135deg, #fdcb6e, #e17055); }
        .weather-widget.antofagasta { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .weather-widget.temuco { background: linear-gradient(135deg, #fd79a8, #e84393); }
        
        .weather-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .weather-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .weather-temp {
            font-size: 1.8em;
            font-weight: bold;
        }
        .weather-details {
            font-size: 0.85em;
            opacity: 0.9;
        }
        .weather-close {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.7;
        }
        .weather-close:hover {
            opacity: 1;
        }
        .weather-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Estilos para el panel de clima del mapa */
        #clickWeatherInfo {
            padding: 15px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        #clickWeatherInfo .weather-icon {
            color: #74b9ff;
            margin-bottom: 10px;
        }
        
        #clickWeatherInfo h6 {
            color: #2d3436;
            font-weight: 600;
        }
        
        #clickWeatherInfo .small {
            color: #636e72;
        }
        
        #clickWeatherInfo .text-muted {
            color: #b2bec3 !important;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .status-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
            margin: 0 5px;
        }
        .status-number {
            font-size: 2em;
            font-weight: bold;
            color: #2d3436;
        }
        .status-label {
            color: #636e72;
            font-size: 0.9em;
        }
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .alert-item {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #e17055;
            background: #ffeaa7;
            border-radius: 0 5px 5px 0;
        }
        .alert-speed { border-left-color: #e17055; }
        .alert-connection { border-left-color: #fd79a8; }
        .alert-stopped { border-left-color: #fdcb6e; }
        .reports-table {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-activity {
            background: #00b894;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
        }
        .btn-activity:hover {
            background: #00a085;
            color: white;
            text-decoration: none;
        }
        .map-controls-external {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        .map-controls-external h6 {
            margin-bottom: 15px;
            color: #2d3436;
            font-weight: 600;
        }
        .map-controls-external .control-group {
            margin-bottom: 0;
        }
        .map-controls-external .form-check-label {
            cursor: pointer;
            font-size: 14px;
            color: #636e72;
            display: flex;
            align-items: center;
        }
        .map-controls-external .form-check-input:checked {
            background-color: #00b894;
            border-color: #00b894;
        }
    </style>
{% endblock %}

{% block content %}
<div class="vehicle-dashboard">
    <div class="dashboard-header">
        <h2><i class="fas fa-truck me-3"></i>Seguridad Vehicular</h2>
        <p>Monitoreo en tiempo real de la flota vehicular</p>
    </div>

    <!-- Widgets del Clima de Múltiples Ciudades -->
    <div class="weather-widgets-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-cloud-sun me-2"></i>Clima en Tiempo Real</h5>
            <div>
                <button id="refreshWeatherBtn" class="btn btn-sm btn-light me-2" title="Actualizar clima">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button id="addCityBtn" class="btn btn-sm btn-primary" title="Agregar ciudad">
                    <i class="fas fa-plus"></i> Ciudad
                </button>
            </div>
        </div>
        <div id="weatherWidgets" class="row">
            <!-- Los widgets se cargarán dinámicamente -->
        </div>
    </div>

    <!-- Controles del Mapa -->
    <div class="row mb-3">
        <div class="col-lg-8">
            <div class="map-controls-external">
                <h6><i class="fas fa-layer-group me-2"></i>Controles del Mapa</h6>
                <div class="d-flex flex-wrap gap-3">
                    <div class="control-group">
                        <label class="form-check-label">
                            <input type="checkbox" id="showVehicles" class="form-check-input me-1" checked>
                            Mostrar Vehículos
                        </label>
                    </div>
                    <div class="control-group">
                        <label class="form-check-label">
                            <input type="checkbox" id="showWeather" class="form-check-input me-1" checked>
                            Información Climática
                        </label>
                    </div>
                    <div class="control-group">
                        <label class="form-check-label">
                            <input type="checkbox" id="showSpeedAlerts" class="form-check-input me-1" checked>
                            Alertas de Velocidad
                        </label>
                    </div>
                    <div class="control-group">
                        <label class="form-check-label">
                            <input type="checkbox" id="showWeatherAlerts" class="form-check-input me-1" checked>
                            Alertas Climáticas
                        </label>
                    </div>
                    <div class="control-group">
                        <label class="form-check-label">
                            <input type="checkbox" id="showTraffic" class="form-check-input me-1">
                            Estado del Tráfico
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mapa -->
        <div class="col-lg-8">
            <div class="map-container">
                <div id="vehicleMap"></div>
                
            </div>
                <!-- Historial de Reportes debajo del mapa -->
        <div class="row mt-4">
            <div class="col-lg-8">
                <div class="reports-table">
                    <h5><i class="fas fa-history me-2"></i>Historial de Reportes</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Patente</th>
                                    <th>Conductor</th>
                                    <th>Tiempo</th>
                                    <th>Incidencia</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in demo_reports %}
                                    <tr>
                                        <td><strong>{{ report.vehicle }}</strong></td>
                                        <td>{{ report.driver }}</td>
                                        <td>{{ report.time }}</td>
                                        <td>{{ report.issue }}</td>
                                        <td>
                                            {% if report.issue == 'Ruta completada' %}
                                                <span class="badge bg-success">Completado</span>
                                            {% else %}
                                                <span class="badge bg-warning">Pendiente</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <a href="{% url 'vehicle_activity_log' %}" class="btn-activity">
                        <i class="fas fa-list me-2"></i>Ver Registro de Actividades
                    </a>
                </div>
            </div>
        </div>
            </div>

            <!-- Panel lateral derecho -->
            <div class="col-lg-4">
                <!-- Panel de clima del mapa -->
                <div class="stats-panel mb-3">
                    <h6><i class="fas fa-cloud-sun me-2"></i>Clima del Mapa</h6>
                    <div id="clickWeatherInfo" class="text-center text-muted">
                        <i class="fas fa-mouse-pointer mb-2" style="font-size: 2em;"></i>
                        <p class="small mb-0">Haz clic en el mapa para ver el clima de esa ubicación</p>
                    </div>
                </div>
                <!-- Estados de Vehículos -->
                <div class="stats-panel">
                    <h5><i class="fas fa-chart-bar me-2"></i>Estado de Vehículos</h5>
                    <div class="vehicle-status">
                        <div class="status-item">
                            <div class="status-number text-success">{{ vehicles_on_route }}</div>
                            <div class="status-label">En Ruta</div>
                        </div>
                        <div class="status-item">
                            <div class="status-number text-warning">{{ vehicles_stopped }}</div>
                            <div class="status-label">Detenidos</div>
                        </div>
                        <div class="status-item">
                            <div class="status-number text-danger">{{ vehicles_disconnected }}</div>
                            <div class="status-label">Sin Conexión</div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas -->
                <div class="stats-panel">
                    <h5><i class="fas fa-tachometer-alt me-2"></i>Estadísticas</h5>
                    <div class="mb-2">
                        <strong>Excesos de Velocidad:</strong> {{ stats.speed_violations }}
                    </div>
                    <div class="mb-2">
                        <strong>Tiempo Detenido Promedio:</strong> {{ stats.stopped_time_avg }} min
                    </div>
                    <div class="mb-2">
                        <strong>Mayor Tiempo Manejando:</strong> {{ stats.longest_drive_time }} hrs
                    </div>
                    <div class="mb-2">
                        <strong>Problemas de Conexión:</strong> {{ stats.connection_issues }}
                    </div>
                </div>

                <!-- Alertas -->
                <div class="alerts-section">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Alertas Activas</h5>
                    {% for alert in demo_alerts %}
                        <div class="alert-item alert-{{ alert.type }}">
                            <strong>{{ alert.vehicle }}</strong> - {{ alert.time }}<br>
                            <small>{{ alert.message }}</small>
                        </div>
                    {% endfor %}
                </div>
                
            </div>
        </div>

<div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fab fa-waze me-2"></i>Visor de Tráfico en Vivo (Waze)</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{% url 'vehicle_security_dashboard' %}" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="ciudad" class="form-control" placeholder="Buscar ciudad (ej: Punta Arenas, Santiago)..." value="{{ ciudad_actual }}">
                            <button class="btn btn-primary" type="submit"><i class="fas fa-search me-2"></i>Buscar</button>
                        </div>
                    </form>
                    
                    <div class="map-container" style="height: 60vh;">
                        <iframe 
                            src="https://embed.waze.com/iframe?zoom=12&lat={{ waze_lat }}&lon={{ waze_lon }}&ct=livemap"
                            style="width: 100%; height: 100%; border: none; border-radius: 8px;">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Datos de vehículos con información climática (demo) - Punta Arenas, Chile
            var vehicles = [
                {id: 1, name: 'ABC-123', lat: -53.1638, lng: -70.9171, speed: 35, status: 'En ruta', driver: 'Juan Pérez', weather: {temp: 8, condition: 'Viento fuerte', icon: '💨'}, speedLimit: 50, fuel: 75, odometer: 45230, lastMaintenance: '15/11/2024', model: 'Toyota Hilux 2022', engine: 'Encendido', doors: 'Cerradas', battery: 95},
                {id: 2, name: 'DEF-456', lat: -53.1558, lng: -70.9098, speed: 0, status: 'Detenido', driver: 'María González', weather: {temp: 6, condition: 'Nublado', icon: '☁️'}, speedLimit: 60, fuel: 45, odometer: 38750, lastMaintenance: '08/11/2024', model: 'Ford Ranger 2021', engine: 'Apagado', doors: 'Cerradas', battery: 88},
                {id: 3, name: 'GHI-789', lat: -53.1478, lng: -70.8925, speed: 45, status: 'En ruta', driver: 'Carlos López', weather: {temp: 4, condition: 'Lluvia ligera', icon: '🌧️'}, speedLimit: 50, fuel: 20, odometer: 52100, lastMaintenance: '02/11/2024', model: 'Chevrolet S10 2023', engine: 'Encendido', doors: 'Cerradas', battery: 92},
                {id: 4, name: 'JKL-012', lat: -53.1398, lng: -70.8752, speed: 25, status: 'En ruta', driver: 'Ana Martínez', weather: {temp: 7, condition: 'Parcialmente nublado', icon: '⛅'}, speedLimit: 40, fuel: 85, odometer: 29800, lastMaintenance: '20/11/2024', model: 'Nissan Frontier 2022', engine: 'Encendido', doors: 'Cerradas', battery: 97},
                {id: 5, name: 'MNO-345', lat: -53.1318, lng: -70.8579, speed: 0, status: 'Offline', driver: 'Pedro Martín', weather: {temp: 3, condition: 'Niebla', icon: '🌫️'}, speedLimit: 60, fuel: 10, odometer: 67450, lastMaintenance: '25/10/2024', model: 'Mitsubishi L200 2020', engine: 'Apagado', doors: 'Abiertas', battery: 45}
            ];
            
            // Inicializar mapa - Punta Arenas, Chile
            var map = L.map('vehicleMap').setView([-53.1638, -70.9171], 12);
            
            // Agregar capa de mapa
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Grupos de capas
            var vehicleMarkers = L.layerGroup().addTo(map);
            var weatherMarkers = L.layerGroup().addTo(map);
            var speedAlertMarkers = L.layerGroup().addTo(map);
            var weatherAlertMarkers = L.layerGroup().addTo(map);
            var trafficMarkers = L.layerGroup();
            
            // Función para determinar alertas
            function getVehicleAlerts(vehicle) {
                var alerts = [];
                
                // Alerta de velocidad según clima
                var weatherSpeedLimit = vehicle.speedLimit;
                if (vehicle.weather.condition === 'Lluvia ligera' || vehicle.weather.condition === 'Niebla') {
                    weatherSpeedLimit = vehicle.speedLimit * 0.8; // Reducir 20% en mal clima
                }
                
                if (vehicle.speed > weatherSpeedLimit && vehicle.status === 'En ruta') {
                    alerts.push({
                        type: 'speed',
                        message: `Velocidad excesiva para condiciones climáticas (${vehicle.speed} km/h en ${vehicle.weather.condition})`
                    });
                }
                
                return alerts;
            }
            
            // Función para crear popup de vehículo
            function createVehiclePopup(vehicle) {
                var alerts = getVehicleAlerts(vehicle);
                var alertsHtml = '';
                
                alerts.forEach(function(alert) {
                    var alertClass = alert.type === 'speed' ? 'speed-alert' : 'weather-alert';
                    alertsHtml += `<div class="${alertClass}">${alert.message}</div>`;
                });
                
                var fuelColor = vehicle.fuel > 50 ? '#00b894' : vehicle.fuel > 25 ? '#fdcb6e' : '#e17055';
                var batteryColor = vehicle.battery > 70 ? '#00b894' : vehicle.battery > 40 ? '#fdcb6e' : '#e17055';
                
                return `
                    <div class="weather-popup" style="min-width: 280px;">
                        <div style="border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 8px;">
                            <strong style="font-size: 16px;">${vehicle.name}</strong>
                            <div style="font-size: 12px; color: #666;">${vehicle.model}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div><strong>Conductor:</strong><br>${vehicle.driver}</div>
                            <div><strong>Estado:</strong><br><span style="color: ${vehicle.status === 'En ruta' ? '#00b894' : vehicle.status === 'Detenido' ? '#fdcb6e' : '#e17055'};">${vehicle.status}</span></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div><strong>Velocidad:</strong><br>${vehicle.speed} km/h</div>
                            <div><strong>Kilometraje:</strong><br>${vehicle.odometer.toLocaleString()} km</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div><strong>Combustible:</strong><br><span style="color: ${fuelColor}; font-weight: bold;">${vehicle.fuel}%</span></div>
                            <div><strong>Batería:</strong><br><span style="color: ${batteryColor}; font-weight: bold;">${vehicle.battery}%</span></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div><strong>Motor:</strong><br>${vehicle.engine}</div>
                            <div><strong>Puertas:</strong><br><span style="color: ${vehicle.doors === 'Cerradas' ? '#00b894' : '#e17055'};">${vehicle.doors}</span></div>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <strong>Última Mantención:</strong> ${vehicle.lastMaintenance}
                        </div>
                        
                        <hr style="margin: 8px 0; border: 1px solid #eee;">
                        
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <div class="weather-icon" style="font-size: 20px;">${vehicle.weather.icon}</div>
                            <div>
                                <strong>Clima:</strong> ${vehicle.weather.condition}<br>
                                <strong>Temperatura:</strong> ${vehicle.weather.temp}°C
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #666;">
                            <strong>Límite sugerido:</strong> ${vehicle.weather.condition === 'Lluvia ligera' || vehicle.weather.condition === 'Niebla' ? Math.round(vehicle.speedLimit * 0.8) : vehicle.speedLimit} km/h
                        </div>
                        
                        ${alertsHtml}
                    </div>
                `;
            }
            
            // Agregar marcadores de vehículos
            function addVehicleMarkers() {
                vehicleMarkers.clearLayers();
                
                vehicles.forEach(function(vehicle) {
                    var alerts = getVehicleAlerts(vehicle);
                    var hasSpeedAlert = alerts.some(a => a.type === 'speed');
                    var hasWeatherAlert = alerts.some(a => a.type === 'weather');
                    
                    var color = vehicle.status === 'En ruta' ? 
                               (hasSpeedAlert ? '#e17055' : '#00b894') : 
                               vehicle.status === 'Detenido' ? '#fdcb6e' : '#636e72';
                    
                    var marker = L.circleMarker([vehicle.lat, vehicle.lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.8,
                        radius: hasSpeedAlert || hasWeatherAlert ? 12 : 8,
                        weight: hasSpeedAlert || hasWeatherAlert ? 3 : 2
                    });
                    
                    marker.bindPopup(createVehiclePopup(vehicle));
                    vehicleMarkers.addLayer(marker);
                });
            }
            
            // Agregar marcadores de clima
            function addWeatherMarkers() {
                weatherMarkers.clearLayers();
                
                vehicles.forEach(function(vehicle) {
                    var weatherIcon = L.divIcon({
                        html: `<div style="font-size: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${vehicle.weather.icon}</div>`,
                        iconSize: [25, 25],
                        className: 'weather-icon-marker'
                    });
                    
                    var marker = L.marker([vehicle.lat + 0.005, vehicle.lng + 0.005], {icon: weatherIcon});
                    marker.bindPopup(`
                        <strong>Clima en ${vehicle.name}</strong><br>
                        ${vehicle.weather.condition}<br>
                        Temperatura: ${vehicle.weather.temp}°C
                    `);
                    weatherMarkers.addLayer(marker);
                });
            }
            
            // Agregar marcadores de alertas de velocidad
            function addSpeedAlertMarkers() {
                speedAlertMarkers.clearLayers();
                
                vehicles.forEach(function(vehicle) {
                    var alerts = getVehicleAlerts(vehicle);
                    var speedAlert = alerts.find(a => a.type === 'speed');
                    
                    if (speedAlert) {
                        var alertIcon = L.divIcon({
                            html: '<div style="background: #e17055; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">!</div>',
                            iconSize: [20, 20],
                            className: 'speed-alert-marker'
                        });
                        
                        var marker = L.marker([vehicle.lat - 0.005, vehicle.lng - 0.005], {icon: alertIcon});
                        marker.bindPopup(`<strong>Alerta de Velocidad</strong><br>${speedAlert.message}`);
                        speedAlertMarkers.addLayer(marker);
                    }
                });
            }
            
            // Agregar marcadores de alertas climáticas
            function addWeatherAlertMarkers() {
                weatherAlertMarkers.clearLayers();
                
                vehicles.forEach(function(vehicle) {
                    var alerts = getVehicleAlerts(vehicle);
                    var weatherAlert = alerts.find(a => a.type === 'weather');
                    
                    if (weatherAlert) {
                        var alertIcon = L.divIcon({
                            html: '<div style="background: #ffa726; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">⚠</div>',
                            iconSize: [20, 20],
                            className: 'weather-alert-marker'
                        });
                        
                        var marker = L.marker([vehicle.lat + 0.005, vehicle.lng - 0.005], {icon: alertIcon});
                        marker.bindPopup(`<strong>Alerta Climática</strong><br>${weatherAlert.message}`);
                        weatherAlertMarkers.addLayer(marker);
                    }
                });
            }
            
            // Agregar marcadores de tráfico (demo)
            function addTrafficMarkers() {
                trafficMarkers.clearLayers();
                
                var trafficPoints = [
                    {lat: -33.4400, lng: -70.6600, level: 'Alto', color: '#e17055'},
                    {lat: -33.4300, lng: -70.6200, level: 'Medio', color: '#fdcb6e'},
                    {lat: -33.4100, lng: -70.5800, level: 'Bajo', color: '#00b894'}
                ];
                
                trafficPoints.forEach(function(point) {
                    var trafficIcon = L.divIcon({
                        html: `<div style="background: ${point.color}; color: white; border-radius: 4px; padding: 2px 6px; font-size: 10px; font-weight: bold; border: 1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">🚗</div>`,
                        iconSize: [30, 20],
                        className: 'traffic-marker'
                    });
                    
                    var marker = L.marker([point.lat, point.lng], {icon: trafficIcon});
                    marker.bindPopup(`<strong>Tráfico ${point.level}</strong><br>Nivel de congestión: ${point.level}`);
                    trafficMarkers.addLayer(marker);
                });
            }
            
            // Inicializar marcadores
            addVehicleMarkers();
            addWeatherMarkers();
            addSpeedAlertMarkers();
            addWeatherAlertMarkers();
            addTrafficMarkers();
            
            // Controles de capas
            document.getElementById('showVehicles').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(vehicleMarkers);
                } else {
                    map.removeLayer(vehicleMarkers);
                }
            });
            
            document.getElementById('showWeather').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(weatherMarkers);
                } else {
                    map.removeLayer(weatherMarkers);
                }
            });
            
            document.getElementById('showSpeedAlerts').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(speedAlertMarkers);
                } else {
                    map.removeLayer(speedAlertMarkers);
                }
            });
            
            document.getElementById('showWeatherAlerts').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(weatherAlertMarkers);
                } else {
                    map.removeLayer(weatherAlertMarkers);
                }
            });
            
            document.getElementById('showTraffic').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(trafficMarkers);
                } else {
                    map.removeLayer(trafficMarkers);
                }
            });
            
            // Variables globales para el clima
              let activeCities = JSON.parse(localStorage.getItem('selectedCities')) || ['santiago', 'punta_arenas', 'valparaiso'];
              let weatherData = {};
              
              // Función para guardar ciudades seleccionadas
              function saveSelectedCities() {
                  localStorage.setItem('selectedCities', JSON.stringify(activeCities));
              }
              
              // Función para remover una ciudad (global)
              window.removeCity = function(cityKey) {
                  activeCities = activeCities.filter(city => city !== cityKey);
                  delete weatherData[cityKey];
                  saveSelectedCities();
                  renderWeatherWidgets();
              };
            
            // Función para obtener clima de múltiples ciudades
            async function loadMultipleCitiesWeather(cities = activeCities) {
                try {
                    const citiesParam = cities.join(',');
                    const response = await fetch(`/api/weather/cities/?cities=${citiesParam}`);
                    const data = await response.json();
                    weatherData = data;
                    renderWeatherWidgets();
                } catch (error) {
                    console.error('Error obteniendo clima:', error);
                    showWeatherError();
                }
            }
            
            // Función para renderizar widgets de clima
            function renderWeatherWidgets() {
                const container = document.getElementById('weatherWidgets');
                container.innerHTML = '';
                
                Object.keys(weatherData).forEach(cityKey => {
                    const city = weatherData[cityKey];
                    const widget = createWeatherWidget(cityKey, city);
                    container.appendChild(widget);
                });
            }
            
            // Función para crear un widget de clima
            function createWeatherWidget(cityKey, cityData) {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                const widget = document.createElement('div');
                widget.className = `weather-widget ${cityKey}`;
                widget.innerHTML = `
                    <button class="weather-close" onclick="removeCity('${cityKey}')">&times;</button>
                    <div class="weather-compact">
                        <div class="weather-info">
                            <div class="weather-temp">${cityData.temperature}°C</div>
                            <div>
                                <div><strong>${cityData.name}</strong></div>
                                <div>${cityData.description}</div>
                                <div class="weather-details">Humedad: ${cityData.humidity}% | Viento: ${cityData.wind_speed} km/h</div>
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-${getWeatherIcon(cityData.icon)}" style="font-size: 2em; opacity: 0.8;"></i>
                        </div>
                    </div>
                `;
                
                // Agregar evento click para centrar mapa en la ciudad
                widget.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('weather-close')) {
                        map.setView([cityData.lat, cityData.lon], 10);
                        
                        // Mostrar popup en el mapa
                        L.popup()
                            .setLatLng([cityData.lat, cityData.lon])
                            .setContent(`
                                <div style="text-align: center;">
                                    <strong>Clima en ${cityData.name}</strong><br>
                                    ${cityData.description}<br>
                                    <strong>${cityData.temperature}°C</strong>
                                </div>
                            `)
                            .openOn(map);
                    }
                });
                
                col.appendChild(widget);
                return col;
            }
            
            // Función para obtener icono del clima
            function getWeatherIcon(iconCode) {
                const iconMap = {
                    '01d': 'sun', '01n': 'moon',
                    '02d': 'cloud-sun', '02n': 'cloud-moon',
                    '03d': 'cloud', '03n': 'cloud',
                    '04d': 'cloud', '04n': 'cloud',
                    '09d': 'cloud-rain', '09n': 'cloud-rain',
                    '10d': 'cloud-sun-rain', '10n': 'cloud-moon-rain',
                    '11d': 'bolt', '11n': 'bolt',
                    '13d': 'snowflake', '13n': 'snowflake',
                    '50d': 'smog', '50n': 'smog'
                };
                return iconMap[iconCode] || 'cloud';
            }
            
            // Función para mostrar error de clima
            function showWeatherError() {
                const container = document.getElementById('weatherWidgets');
                container.innerHTML = `
                    <div class="col-12">
                        <div class="weather-loading">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error al cargar datos del clima. <a href="#" onclick="loadMultipleCitiesWeather()">Reintentar</a>
                        </div>
                    </div>
                `;
            }
            
            // Función para agregar una ciudad
              function addCity() {
                  const availableCities = {
                      'arica': 'Arica',
                      'iquique': 'Iquique',
                      'antofagasta': 'Antofagasta',
                      'calama': 'Calama',
                      'copiapo': 'Copiapó',
                      'la_serena': 'La Serena',
                      'valparaiso': 'Valparaíso',
                      'vina_del_mar': 'Viña del Mar',
                      'santiago': 'Santiago',
                      'rancagua': 'Rancagua',
                      'talca': 'Talca',
                      'chillan': 'Chillán',
                      'concepcion': 'Concepción',
                      'temuco': 'Temuco',
                      'valdivia': 'Valdivia',
                      'osorno': 'Osorno',
                      'puerto_montt': 'Puerto Montt',
                      'coyhaique': 'Coyhaique',
                      'punta_arenas': 'Punta Arenas',
                      'puerto_natales': 'Puerto Natales'
                  };
                  
                  const unusedCities = Object.keys(availableCities).filter(city => !activeCities.includes(city));
                  
                  if (unusedCities.length === 0) {
                      alert('Ya se están mostrando todas las ciudades disponibles.');
                      return;
                  }
                  
                  // Crear un select más amigable
                  const citySelect = document.createElement('select');
                  citySelect.style.cssText = 'width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;';
                  
                  const defaultOption = document.createElement('option');
                  defaultOption.value = '';
                  defaultOption.textContent = 'Selecciona una ciudad...';
                  citySelect.appendChild(defaultOption);
                  
                  unusedCities.forEach(cityKey => {
                      const option = document.createElement('option');
                      option.value = cityKey;
                      option.textContent = availableCities[cityKey];
                      citySelect.appendChild(option);
                  });
                  
                  // Crear modal personalizado
                  const modal = document.createElement('div');
                  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                  
                  const modalContent = document.createElement('div');
                  modalContent.style.cssText = 'background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;';
                  
                  modalContent.innerHTML = `
                      <h4 style="margin-top: 0;">Agregar Ciudad</h4>
                      <p>Selecciona una ciudad para agregar al display de clima:</p>
                  `;
                  
                  modalContent.appendChild(citySelect);
                  
                  const buttonContainer = document.createElement('div');
                  buttonContainer.style.cssText = 'margin-top: 15px; text-align: right;';
                  
                  const cancelBtn = document.createElement('button');
                  cancelBtn.textContent = 'Cancelar';
                  cancelBtn.style.cssText = 'margin-right: 10px; padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;';
                  
                  const addBtn = document.createElement('button');
                  addBtn.textContent = 'Agregar';
                  addBtn.style.cssText = 'padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;';
                  
                  cancelBtn.onclick = () => document.body.removeChild(modal);
                  addBtn.onclick = () => {
                      const selectedCity = citySelect.value;
                      if (selectedCity) {
                          activeCities.push(selectedCity);
                          saveSelectedCities();
                          loadMultipleCitiesWeather();
                          document.body.removeChild(modal);
                      } else {
                          alert('Por favor selecciona una ciudad.');
                      }
                  };
                  
                  buttonContainer.appendChild(cancelBtn);
                  buttonContainer.appendChild(addBtn);
                  modalContent.appendChild(buttonContainer);
                  modal.appendChild(modalContent);
                  document.body.appendChild(modal);
              }
            
            // Event listeners
            document.getElementById('refreshWeatherBtn').addEventListener('click', function() {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                loadMultipleCitiesWeather().finally(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt"></i>';
                });
            });
            
            document.getElementById('addCityBtn').addEventListener('click', addCity);
            
            // Cargar clima inicial
            loadMultipleCitiesWeather();
            
            // Función para obtener nombre de ciudad por coordenadas
            async function getCityName(lat, lng) {
                try {
                    const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lng}&limit=1&appid=af043322c5d5657c7b6c16a888ecd196`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const location = data[0];
                        return location.name + (location.state ? `, ${location.state}` : '') + (location.country ? `, ${location.country}` : '');
                    }
                    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                } catch (error) {
                    console.error('Error obteniendo nombre de ciudad:', error);
                    return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                }
            }
            
            // Click en el mapa para obtener clima por coordenadas
            map.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // Mostrar loading en el panel
                const clickWeatherInfo = document.getElementById('clickWeatherInfo');
                clickWeatherInfo.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin mb-2" style="font-size: 2em;"></i>
                        <p class="small mb-0">Obteniendo clima y ubicación...</p>
                    </div>
                `;
                
                try {
                    // Obtener clima y nombre de ciudad en paralelo
                    const [weatherResponse, cityName] = await Promise.all([
                        fetch(`/api/weather/?lat=${lat}&lon=${lng}`),
                        getCityName(lat, lng)
                    ]);
                    
                    const weatherData = await weatherResponse.json();
                    
                    // Actualizar panel con información del clima
                    clickWeatherInfo.innerHTML = `
                        <div class="text-center w-100">
                            <i class="fas fa-${getWeatherIcon(weatherData.icon)} weather-icon" style="font-size: 2.5em;"></i>
                            <h5 class="mb-2 text-primary">${weatherData.temperature}°C</h5>
                            <p class="mb-2 fw-bold">${weatherData.description}</p>
                            <div class="row text-center mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Humedad</small><br>
                                    <strong>${weatherData.humidity}%</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Viento</small><br>
                                    <strong>${weatherData.wind_speed} km/h</strong>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-top">
                                <small class="text-muted">
                                    📍 ${cityName}
                                </small>
                            </div>
                        </div>
                    `;
                    
                    // También mostrar popup en el mapa
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(`
                            <div style="text-align: center;">
                                <strong>Clima en ${cityName}</strong><br>
                                ${weatherData.description}<br>
                                <strong>${weatherData.temperature}°C</strong><br>
                                <small>Humedad: ${weatherData.humidity}% | Viento: ${weatherData.wind_speed} km/h</small>
                            </div>
                        `)
                        .openOn(map);
                } catch (error) {
                    console.error('Error obteniendo clima:', error);
                    clickWeatherInfo.innerHTML = `
                        <div class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle mb-2" style="font-size: 2em;"></i>
                            <p class="small mb-0">Error al obtener clima</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="document.getElementById('clickWeatherInfo').innerHTML = '<div class=\"text-center text-muted\"><i class=\"fas fa-mouse-pointer mb-2\" style=\"font-size: 2em;\"></i><p class=\"small mb-0\">Haz clic en el mapa para ver el clima de esa ubicación</p></div>';">Reintentar</button>
                        </div>
                    `;
                }
            });
            
            // Actualizar datos cada 30 segundos
            setInterval(function() {
                // Aquí se podría hacer una llamada AJAX para actualizar posiciones
                console.log('Actualizando posiciones de vehículos...');
                addVehicleMarkers();
                addWeatherMarkers();
                addSpeedAlertMarkers();
                addWeatherAlertMarkers();
            }, 30000);
        });
    </script>
{% endblock %}