{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Generar Correo de Novedades{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-4">
                <h2 class="h3">Generar Correo de Novedades</h2>
                <p class="text-muted">Seleccione una empresa para adjuntar sus novedades al reporte.</p>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}
                        
                        {{ form.company|as_crispy_field }}
                        
                        <div id="div_id_updates" class="mt-3">
                            <label class="form-label fw-bold">Novedades a Incluir*</label>
                            <div id="updates-accordion-container" class="accordion mt-2">
                                <div class="accordion-item">
                                    <div class="accordion-header">
                                        <button class="accordion-button collapsed bg-light" type="button" disabled>
                                            <span class="text-muted">Seleccione una empresa para ver sus novedades.</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {{ form.observations|as_crispy_field }}
                        
                        <div class="d-flex justify-content-end mt-4">
                            <a href="{% url 'operator_dashboard' %}" class="btn btn-outline-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Guardar y Enviar a Aprobación</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const companySelect = document.getElementById('id_company');
    const updatesContainer = document.getElementById('updates-accordion-container');

    companySelect.addEventListener('change', function() {
        const companyId = this.value;
        updatesContainer.innerHTML = `
            <div class="accordion-item">
                <div class="accordion-header"><button class="accordion-button collapsed" type="button" disabled>
                    <span class="text-muted">Cargando novedades...</span>
                </button></div>
            </div>`;

        if (!companyId) {
            updatesContainer.innerHTML = `
            <div class="accordion-item">
                <div class="accordion-header"><button class="accordion-button collapsed" type="button" disabled>
                    <span class="text-muted">Seleccione una empresa para ver sus novedades.</span>
                </button></div>
            </div>`;
            return;
        }

        const url = `/ajax/get-updates/${companyId}/`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                updatesContainer.innerHTML = ''; // Limpia el contenedor
                
                if (data.grouped_updates && data.grouped_updates.length > 0) {
                    data.grouped_updates.forEach((group, index) => {
                        let checkboxesHTML = '';
                        group.updates.forEach(update => {
                            checkboxesHTML += `
                                <div class="form-check">
                                    <input type="checkbox" name="updates" value="${update.id}" class="form-check-input" id="update_${update.id}">
                                    <label class="form-check-label" for="update_${update.id}">${update.text}</label>
                                </div>`;
                        });

                        const accordionItemHTML = `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading_${index}">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapse_${index}" aria-expanded="true" aria-controls="collapse_${index}">
                                        <strong>${group.installation_name}</strong>
                                    </button>
                                </h2>
                                <div id="collapse_${index}" class="accordion-collapse collapse show" 
                                     aria-labelledby="heading_${index}">
                                    <div class="accordion-body">
                                        ${checkboxesHTML}
                                    </div>
                                </div>
                            </div>`;
                        updatesContainer.innerHTML += accordionItemHTML;
                    });
                } else {
                    updatesContainer.innerHTML = `
                    <div class="accordion-item">
                        <div class="accordion-header"><button class="accordion-button collapsed" type="button" disabled>
                            <span class="text-muted">Esta empresa no tiene novedades registradas.</span>
                        </button></div>
                    </div>`;
                }
            })
            .catch(error => {
                console.error('Error al cargar las novedades:', error);
                updatesContainer.innerHTML = `
                    <div class="accordion-item">
                        <div class="accordion-header"><button class="accordion-button collapsed" type="button" disabled>
                            <span class="text-danger">No se pudieron cargar las novedades.</span>
                        </button></div>
                    </div>`;
            });
    });

    // Dispara el evento 'change' al cargar la página para inicializar el campo
    companySelect.dispatchEvent(new Event('change'));
});
</script>
{% endblock %}