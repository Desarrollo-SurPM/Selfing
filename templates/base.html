{% load static %}

<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}SELFING - Sistema de Seguridad{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=1.7">
    <link rel="stylesheet" href="{% static 'css/color_theme.css' %}">
    
{% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
                <img src="{% static 'images/Logo.png' %}" alt="SELFING Logo" style="height: 30px;">
            </a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if user.is_authenticated %}
                        {% if global_active_shift and global_active_shift.actual_start_time %}
                        <li class="nav-item me-3">
                            <span class="badge bg-light text-dark p-2">
                                Tiempo para realizar ronda: <strong id="global-round-countdown">--:--</strong>
                            </span>
                        </li>
                        {% endif %}

                        <li class="nav-item">
                            <span class="welcome-text">
                                <i class="fas fa-user"></i>
                                Bienvenido, {{ user.username }}
                            </span>
                        </li>
                        <li class="nav-item">
                            <form method="post" action="{% url 'logout' %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Cerrar Sesión
                                </button>
                            </form>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Iniciar Sesión</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
    </main>
    
    <div class="modal fade" id="checklistAlarmModal" tabindex="-1" aria-labelledby="checklistAlarmLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning"><div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="fas fa-tasks"></i> ¡Checklist Pendiente!</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="fs-5">Tienes tareas de checklist pendientes.</p></div><div class="modal-footer justify-content-center"><a href="{% url 'checklist_view' %}" class="btn btn-warning">Ir a Checklist</a><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Aceptar</button></div></div>
        </div>
    </div>
    <div class="modal fade" id="roundAlarmModal" tabindex="-1" aria-labelledby="roundAlarmLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-info"><div class="modal-header bg-info text-white"><h5 class="modal-title"><i class="fas fa-walking"></i> ¡Hora de la Ronda!</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="fs-5">Debes iniciar tu ronda virtual.</p></div><div class="modal-footer justify-content-center"><button type="button" id="startRoundFromModal" class="btn btn-info">Iniciar Ronda</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Más Tarde</button></div></div>
        </div>
    </div>

    <audio id="alarm-sound" src="{% static 'sounds/alarm.mp3' %}" preload="auto"></audio>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const startRoundBtn = document.getElementById('startRoundFromModal');
        const alarmSound = document.getElementById('alarm-sound');
        
        if (startRoundBtn) {
            startRoundBtn.addEventListener('click', function() {
                // Busca el token CSRF del formulario de logout existente en el navbar
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const url = "{% url 'start_virtual_round' %}"; 

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Ocultar modal y detener sonido
                        const modalEl = document.getElementById('roundAlarmModal');
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) modalInstance.hide();
                        
                        if (alarmSound) {
                            alarmSound.pause();
                            alarmSound.currentTime = 0;
                        }
                        // Recargar para actualizar estado
                        window.location.reload(); 
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
    });
    </script>
</body>
</html>