{% load static %}

<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}SELFING - Sistema de Seguridad{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=1.7">
    <link rel="stylesheet" href="{% static 'css/color_theme.css' %}">
    
{% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">SELFING</a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if user.is_authenticated %}
                        {% if global_active_shift and global_active_shift.actual_start_time %}
                        <li class="nav-item me-3">
                            <span class="badge bg-light text-dark p-2">
                                Próxima Ronda: <strong id="global-round-countdown">--:--</strong>
                            </span>
                        </li>
                        {% endif %}

                        <li class="nav-item">
                            <span class="welcome-text">
                                <i class="fas fa-user"></i>
                                Bienvenido, {{ user.username }}
                            </span>
                        </li>
                        <li class="nav-item">
                            <form method="post" action="{% url 'logout' %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Cerrar Sesión
                                </button>
                            </form>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Iniciar Sesión</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        {% block content %}{% endblock %}
    </main>
    
    <div class="modal fade" id="checklistAlarmModal" tabindex="-1" aria-labelledby="checklistAlarmLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning"><div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="fas fa-tasks"></i> ¡Checklist Pendiente!</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="fs-5">Tienes tareas de checklist pendientes.</p></div><div class="modal-footer justify-content-center"><a href="{% url 'checklist_view' %}" class="btn btn-warning">Ir a Checklist</a><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Aceptar</button></div></div>
        </div>
    </div>
    <div class="modal fade" id="roundAlarmModal" tabindex="-1" aria-labelledby="roundAlarmLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-info"><div class="modal-header bg-info text-white"><h5 class="modal-title"><i class="fas fa-walking"></i> ¡Hora de la Ronda!</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center py-4"><p class="fs-5">Debes iniciar tu ronda virtual.</p></div><div class="modal-footer justify-content-center"><button type="button" id="startRoundFromModal" class="btn btn-info">Iniciar Ronda</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Más Tarde</button></div></div>
        </div>
    </div>

    <audio id="alarm-sound" src="{% static 'sounds/alarm.mp3' %}" preload="auto"></audio>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}

    {% if user.is_authenticated and not user.is_staff and global_active_shift and global_active_shift.actual_start_time %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const checklistModal = new bootstrap.Modal(document.getElementById('checklistAlarmModal'));
        const roundModal = new bootstrap.Modal(document.getElementById('roundAlarmModal'));
        const alarmSound = document.getElementById('alarm-sound');
        let isAlarmActive = false;

        // --- LÓGICA DE ALARMA DE CHECKLIST (vía API) ---
        function checkChecklistAlarm() {
            if (isAlarmActive) return;
            fetch("{% url 'check_pending_alarms' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.pending_checklist) {
                        isAlarmActive = true;
                        checklistModal.show();
                        if(alarmSound) alarmSound.play().catch(e => {});
                    }
                });
        }
        setInterval(checkChecklistAlarm, 60000); // Revisa cada minuto
        checkChecklistAlarm(); // Revisa al cargar

        // --- LÓGICA DE TEMPORIZADOR Y ALARMA DE RONDA (CLIENT-SIDE) ---
       const countdownElementIds = ['global-round-countdown', 'dashboard-round-countdown'];
        
        const shiftStartTime = new Date("{{ global_active_shift.actual_start_time.isoformat }}");

        function updateRoundCountdown() {
            const now = new Date();
            const elapsedMilliseconds = now - shiftStartTime;
            const hourInMilliseconds = 3600000;
            const nextHourMark = Math.floor(elapsedMilliseconds / hourInMilliseconds) + 1;
            const nextRoundTime = new Date(shiftStartTime.getTime() + nextHourMark * hourInMilliseconds);
            const timeRemaining = nextRoundTime - now;

            let formattedTime = "--:--"; // Valor por defecto
            if (timeRemaining > 0) {
                const minutes = String(Math.floor((timeRemaining % hourInMilliseconds) / 60000)).padStart(2, '0');
                const seconds = String(Math.floor((timeRemaining % 60000) / 1000)).padStart(2, '0');
                formattedTime = `${minutes}:${seconds}`;
            }

            // Bucle que actualiza cada temporizador en la página
            countdownElementIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) { // Solo si el elemento existe en la página actual
                    element.textContent = formattedTime;
                }
            })

            // Disparar la alarma en el minuto :00 de cada hora del turno
            if (now.getMinutes() === 0 && now.getSeconds() === 0) {
                 if (isAlarmActive) return;
                 isAlarmActive = true;
                 roundModal.show();
                 if(alarmSound) alarmSound.play().catch(e => {});
            }
        }
        setInterval(updateRoundCountdown, 1000);
        updateRoundCountdown();
        
        // Resetea la bandera de alarma cuando se cierra un modal
        document.getElementById('checklistAlarmModal').addEventListener('hidden.bs.modal', () => { isAlarmActive = false; });
        document.getElementById('roundAlarmModal').addEventListener('hidden.bs.modal', () => { isAlarmActive = false; });

        // Lógica para el botón "Iniciar Ronda" del modal
        document.getElementById('startRoundFromModal').addEventListener('click', function() {
             // Aquí iría la lógica para iniciar la ronda, similar a la del dashboard
             // Por simplicidad, por ahora solo cerramos el modal.
             roundModal.hide();
             // Idealmente, esto haría una llamada fetch a una vista 'start_virtual_round'
        });
    });
    </script>
    {% endif %}
</body>
</html>