{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Registrar Novedad en Bitácora{% endblock %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h2 class="h3">Registrar Novedad en Bitácora</h2>
        <p class="text-muted">Siga los pasos para registrar un nuevo evento.</p>
    </div>

    <div id="company-selection">
        <h4 class="mb-3 fw-normal">Paso 1: Seleccione la Empresa</h4>
        <div class="row g-4 justify-content-center">
            {% for company in companies %}
            <div class="col-md-3">
                <div class="card h-100 card-option company-card company-unique-{{ forloop.counter0|add:0 }}" 
                     data-company-id="{{ company.id }}" 
                     data-company-name="{{ company.name }}"
                     style="border-left: 5px solid {% cycle '#4e73df' '#1cc88a' '#36b9cc' '#f6c23e' '#e74a3b' '#9b59b6' '#fd7e14' '#20c997' '#6f42c1' '#dc3545' %}; 
                            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
                            transition: all 0.3s ease;"
                     onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)';"
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center" 
                         style="background: {% cycle 'linear-gradient(135deg, #4e73df, #224abe)' 'linear-gradient(135deg, #1cc88a, #17a673)' 'linear-gradient(135deg, #36b9cc, #2c9faf)' 'linear-gradient(135deg, #f6c23e, #dda20a)' 'linear-gradient(135deg, #e74a3b, #c0392b)' 'linear-gradient(135deg, #9b59b6, #8e44ad)' 'linear-gradient(135deg, #fd7e14, #e8590c)' 'linear-gradient(135deg, #20c997, #1ba085)' 'linear-gradient(135deg, #6f42c1, #59359a)' 'linear-gradient(135deg, #dc3545, #c82333)' %}; 
                                color: white; 
                                border-radius: 0.375rem;">
                        <i class="fas {% cycle 'fa-building' 'fa-industry' 'fa-store' 'fa-home' 'fa-hospital' 'fa-school' 'fa-university' 'fa-clinic-medical' 'fa-fire-station' 'fa-warehouse' %} fa-3x mb-3" 
                           style="color: rgba(255,255,255,0.9);"></i>
                        <h5 class="card-title h6 text-center" style="color: white; font-weight: 600;">{{ company.name }}</h5>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="text-center mt-4">
            <a href="{% url 'operator_dashboard' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Panel
            </a>
        </div>
    </div>

    <div id="installation-selection" style="display: none;">
        <hr class="my-4">
        <h4 class="mb-3 fw-normal">Paso 2: Seleccione la Instalación para <strong id="company-name-for-installations"></strong></h4>
        <div id="installation-list" class="row g-4 justify-content-center">
            </div>
        <div class="text-center mt-4">
            <button type="button" class="btn btn-outline-secondary back-to-companies">
                <i class="fas fa-arrow-left me-2"></i>Volver a Empresas
            </button>
        </div>
    </div>

    <div id="update-form-container" style="display: none;">
        <hr class="my-4">
        <h4 class="mb-3 fw-normal">Paso 3: Describa la Novedad para <strong id="installation-name-for-form"></strong></h4>
        <form method="post" class="card shadow-sm">
            <div class="card-body">
                {% csrf_token %}
                {{ form.installation|as_crispy_field }}
                {{ form.message|as_crispy_field }}

                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-manual-time">
                        <i class="fas fa-clock me-1"></i> Registrar hora específica (Opcional)
                    </button>
                </div>
                <div id="manual-time-container" style="display: none;">
                    {{ form.manual_timestamp|as_crispy_field }}
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-secondary me-2 back-to-installations">Volver</button>
                    <button type="submit" class="btn btn-primary">Guardar Novedad</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script id="installations-data" type="application/json">
{
    {% for company in companies %}
        "{{ company.id }}": {
            "name": "{{ company.name }}",
            "installations": [
                {% for installation in company.installations.all %}
                    { "id": "{{ installation.id }}", "name": "{{ installation.name }}" }
                    {% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }
        {% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const installationsData = JSON.parse(document.getElementById('installations-data').textContent);

    const companySelectionDiv = document.getElementById('company-selection');
    const installationSelectionDiv = document.getElementById('installation-selection');
    const formContainer = document.getElementById('update-form-container');

    const installationListDiv = document.getElementById('installation-list');
    const hiddenInstallationInput = document.querySelector('input[name="installation"]');
    
    let currentCompanyId = null;

    // --- MANEJO DE CLICS ---
    document.body.addEventListener('click', function(e) {
        const companyCard = e.target.closest('.company-card');
        const installationCard = e.target.closest('.installation-card');
        const backToCompaniesBtn = e.target.closest('.back-to-companies');
        const backToInstallationsBtn = e.target.closest('.back-to-installations');

        if (companyCard) {
            handleCompanySelection(companyCard);
        } else if (installationCard) {
            handleInstallationSelection(installationCard);
        } else if (backToCompaniesBtn) {
            showSection('companies');
        } else if (backToInstallationsBtn) {
            // Re-popula las instalaciones de la empresa actual antes de mostrar
            const companyName = installationsData[currentCompanyId].name;
            populateInstallations(currentCompanyId, companyName);
            showSection('installations');
        }
    });

    // --- FUNCIONES LÓGICAS ---
    function handleCompanySelection(card) {
        currentCompanyId = card.dataset.companyId;
        const companyData = installationsData[currentCompanyId];
        const companyName = companyData.name;
        const companyInstallations = companyData.installations;

        if (companyInstallations && companyInstallations.length > 0) {
            populateInstallations(currentCompanyId, companyName);
            showSection('installations');
        } else {
            alert(`La empresa '${companyName}' no tiene instalaciones registradas.`);
        }
    }

    function handleInstallationSelection(card) {
        const installationId = card.dataset.installationId;
        const installationName = card.dataset.installationName;
        const companyName = installationsData[currentCompanyId].name;
        
        hiddenInstallationInput.value = installationId;
        document.getElementById('installation-name-for-form').textContent = `${installationName} (${companyName})`;
        showSection('form');
    }
    
    function populateInstallations(companyId, companyName) {
        installationListDiv.innerHTML = '';
        const companyInstallations = installationsData[companyId].installations;
        document.getElementById('company-name-for-installations').textContent = companyName;

        // Array de colores y estilos únicos para cada instalación
        const installationStyles = [
            { color: '#4e73df', gradient: 'linear-gradient(135deg, #4e73df, #224abe)', icon: 'fa-warehouse' },
            { color: '#1cc88a', gradient: 'linear-gradient(135deg, #1cc88a, #17a673)', icon: 'fa-industry' },
            { color: '#36b9cc', gradient: 'linear-gradient(135deg, #36b9cc, #2c9faf)', icon: 'fa-building' },
            { color: '#f6c23e', gradient: 'linear-gradient(135deg, #f6c23e, #dda20a)', icon: 'fa-store' },
            { color: '#e74a3b', gradient: 'linear-gradient(135deg, #e74a3b, #c0392b)', icon: 'fa-home' },
            { color: '#9b59b6', gradient: 'linear-gradient(135deg, #9b59b6, #8e44ad)', icon: 'fa-hospital' },
            { color: '#fd7e14', gradient: 'linear-gradient(135deg, #fd7e14, #e8590c)', icon: 'fa-school' },
            { color: '#20c997', gradient: 'linear-gradient(135deg, #20c997, #1ba085)', icon: 'fa-university' },
            { color: '#6f42c1', gradient: 'linear-gradient(135deg, #6f42c1, #59359a)', icon: 'fa-clinic-medical' },
            { color: '#dc3545', gradient: 'linear-gradient(135deg, #dc3545, #c82333)', icon: 'fa-fire-station' }
        ];

        companyInstallations.forEach((inst, index) => {
            // Usar el índice para seleccionar un estilo único, con ciclo si hay más instalaciones que estilos
            const styleIndex = index % installationStyles.length;
            const style = installationStyles[styleIndex];
            
            installationListDiv.innerHTML += `
                <div class="col-md-3">
                    <div class="card h-100 card-option installation-card installation-unique-${styleIndex}" 
                         data-installation-id="${inst.id}" 
                         data-installation-name="${inst.name}"
                         style="border-left: 5px solid ${style.color}; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;"
                         onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.2)';"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';">
                        <div class="card-body d-flex flex-column justify-content-center align-items-center" 
                             style="background: ${style.gradient}; color: white; border-radius: 0.375rem;">
                            <i class="fas ${style.icon} fa-3x mb-3" style="color: rgba(255,255,255,0.9);"></i>
                            <h5 class="card-title h6 text-center" style="color: white; font-weight: 600;">${inst.name}</h5>
                        </div>
                    </div>
                </div>`;
        });
    }
    
    function showSection(sectionName) {
        companySelectionDiv.style.display = 'none';
        installationSelectionDiv.style.display = 'none';
        formContainer.style.display = 'none';

        if (sectionName === 'companies') companySelectionDiv.style.display = 'block';
        if (sectionName === 'installations') installationSelectionDiv.style.display = 'block';
        if (sectionName === 'form') formContainer.style.display = 'block';
    }

    // --- SCRIPT PARA MOSTRAR/OCULTAR LA HORA MANUAL ---
    const toggleButton = document.getElementById('toggle-manual-time');
    const timeContainer = document.getElementById('manual-time-container');

    if (toggleButton) {
        toggleButton.addEventListener('click', function() {
            if (timeContainer.style.display === 'none') {
                timeContainer.style.display = 'block';
            } else {
                timeContainer.style.display = 'none';
                // Limpiamos el valor si el usuario lo oculta
                const manualTimestampInput = document.getElementById('id_manual_timestamp');
                if(manualTimestampInput) {
                    manualTimestampInput.value = '';
                }
            }
        });
    }
});
</script>
{% endblock %}