{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Registrar Novedad en Bitácora{% endblock %}

{% block content %}

<style>
    /* --- ESTILOS VISUALES --- */
    .bitacora-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* GRID ROBUSTO: Se cuadra siempre */
    .saas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    /* TARJETA UNIFICADA: Altura igual para todas */
    .saas-card {
        background: white;
        border: 1px solid #e3e6f0;
        border-radius: 10px;
        padding: 20px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        display: flex;
        flex-direction: column; /* Icono arriba, texto abajo para cuadrar mejor */
        align-items: center;
        justify-content: center;
        text-align: center;
        height: 100%; /* Ocupa toda la altura de la fila */
        min-height: 160px; /* Altura mínima garantizada */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .saas-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.12);
        border-color: #4e73df;
    }

    /* Icono dentro de la tarjeta */
    .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        font-size: 1.8rem;
    }

    .card-title-text {
        font-weight: 700;
        color: #4a4a4a;
        font-size: 1.1rem;
        line-height: 1.3;
    }

    /* Pasos */
    .step-header {
        border-bottom: 2px solid #f0f2f5;
        padding-bottom: 15px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
    }
    .step-badge {
        background: #4e73df;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    /* Clase utilitaria para ocultar el select original pero que siga funcionando */
    .visually-hidden-input {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }
</style>

<div class="bitacora-container">
    
    <div class="text-center mb-5">
        <h2 class="h3 fw-bold text-gray-800">Bitácora Operativa</h2>
        <p class="text-muted">Registro de novedades e incidencias</p>
    </div>

    <div id="section-companies">
        <div class="step-header">
            <span class="step-badge">1</span>
            <h4 class="m-0 text-gray-700">Seleccione Empresa</h4>
        </div>

        <div class="saas-grid">
            {% for company in companies %}
            <div class="saas-card company-trigger" 
                 data-company-id="{{ company.id }}" 
                 data-company-name="{{ company.name }}">
                
                <div class="card-icon" style="background-color: {% cycle '#e8f0fe' '#e6fffa' '#fff8e1' '#fce4ec' '#f3e5f5' %}; color: {% cycle '#1a73e8' '#00b894' '#ffa000' '#e91e63' '#9c27b0' %};">
                    <i class="fas {% cycle 'fa-building' 'fa-industry' 'fa-store' 'fa-warehouse' 'fa-hospital' %}"></i>
                </div>
                <div class="card-title-text">{{ company.name }}</div>
            </div>
            {% endfor %}
        </div>

        <div class="text-center">
            <a href="{% url 'operator_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Panel
            </a>
        </div>
    </div>

    <div id="section-installations" style="display: none;">
        <div class="step-header">
            <span class="step-badge">2</span>
            <h4 class="m-0 text-gray-700">Instalación en <strong id="lbl-company-name" class="text-primary"></strong></h4>
        </div>

        <div id="installations-grid-target" class="saas-grid"></div>

        <div class="text-center mt-4">
            <button class="btn btn-outline-secondary btn-back-companies">
                <i class="fas fa-arrow-left me-2"></i>Cambiar Empresa
            </button>
        </div>
    </div>

    <div id="section-form" style="display: none;">
        <div class="step-header">
            <span class="step-badge">3</span>
            <h4 class="m-0 text-gray-700">Reporte para <strong id="lbl-installation-name" class="text-primary"></strong></h4>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-body p-4">
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="d-none">
                                {{ form.installation }} 
                            </div>

                            {{ form.message|as_crispy_field }}
                            
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    {{ form.attachment|as_crispy_field }}
                                </div>
                            </div>

                            <div class="mt-3 pt-3 border-top">
                                <button type="button" class="btn btn-light text-primary btn-sm fw-bold" id="btn-toggle-time">
                                    <i class="fas fa-clock"></i> Registrar hora manual (opcional)
                                </button>
                                <div id="manual-time-box" class="mt-3" style="display: none;">
                                    {{ form.manual_timestamp|as_crispy_field }}
                                    <small class="text-muted">Formato: HH:MM</small>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-back-installations">Atrás</button>
                                <button type="submit" class="btn btn-primary px-4 fw-bold">
                                    <i class="fas fa-save me-2"></i>Guardar Novedad
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script id="installations-data" type="application/json">
{
    {% for company in companies %}
        "{{ company.id }}": {
            "name": "{{ company.name }}",
            "installations": [
                {% for installation in company.installations.all %}
                    { "id": "{{ installation.id }}", "name": "{{ installation.name }}" }
                    {% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }
        {% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Cargar Datos
    const data = JSON.parse(document.getElementById('installations-data').textContent);
    
    // 2. Referencias DOM
    const secCompanies = document.getElementById('section-companies');
    const secInstallations = document.getElementById('section-installations');
    const secForm = document.getElementById('section-form');
    
    const gridInstallations = document.getElementById('installations-grid-target');
    const lblCompany = document.getElementById('lbl-company-name');
    const lblInstallation = document.getElementById('lbl-installation-name');
    
    // Este es el SELECT real generado por Django. Buscamos por ID estándar o por nombre
    const djangoSelect = document.getElementById('id_installation') || document.querySelector('[name="installation"]');
    
    let selectedCompanyId = null;

    // 3. Manejo de Eventos (Delegación para elementos dinámicos)
    document.body.addEventListener('click', function(e) {
        
        // Click en Tarjeta Empresa
        const companyCard = e.target.closest('.company-trigger');
        if (companyCard) {
            selectedCompanyId = companyCard.dataset.companyId;
            const name = companyCard.dataset.companyName;
            loadInstallations(selectedCompanyId, name);
        }

        // Click en Tarjeta Instalación
        const instCard = e.target.closest('.installation-trigger');
        if (instCard) {
            const instId = instCard.dataset.instId;
            const instName = instCard.dataset.instName;
            selectInstallation(instId, instName);
        }

        // Botones Volver
        if (e.target.closest('.btn-back-companies')) {
            showSection(secCompanies);
        }
        if (e.target.closest('.btn-back-installations')) {
            showSection(secInstallations);
        }

        // Toggle Hora Manual
        if (e.target.closest('#btn-toggle-time')) {
            const box = document.getElementById('manual-time-box');
            const input = document.querySelector('[name="manual_timestamp"]');
            if (box.style.display === 'none') {
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
                if(input) input.value = ''; // Limpiar si se oculta
            }
        }
    });

    // 4. Funciones Lógicas
    function showSection(section) {
        secCompanies.style.display = 'none';
        secInstallations.style.display = 'none';
        secForm.style.display = 'none';
        section.style.display = 'block';
        window.scrollTo(0,0);
    }

    function loadInstallations(companyId, companyName) {
        const companyData = data[companyId];
        if (!companyData || !companyData.installations.length) {
            alert('Esta empresa no tiene instalaciones registradas.');
            return;
        }

        lblCompany.textContent = companyName;
        gridInstallations.innerHTML = ''; // Limpiar anterior

        // Generar HTML de instalaciones
        companyData.installations.forEach(inst => {
            const cardHtml = `
                <div class="saas-card installation-trigger" 
                     data-inst-id="${inst.id}" 
                     data-inst-name="${inst.name}">
                    <div class="card-icon" style="background-color: #e3f2fd; color: #1565c0;">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="card-title-text">${inst.name}</div>
                </div>
            `;
            gridInstallations.insertAdjacentHTML('beforeend', cardHtml);
        });

        showSection(secInstallations);
    }

    function selectInstallation(id, name) {
        // ACTUALIZAR EL FORMULARIO DE DJANGO OCULTO
        if (djangoSelect) {
            djangoSelect.value = id;
            // Para asegurar compatibilidad si es un select2 o similar, disparamos evento change
            djangoSelect.dispatchEvent(new Event('change'));
        } else {
            console.error("Error: No se encontró el campo 'installation' del formulario Django.");
        }

        lblInstallation.textContent = name;
        showSection(secForm);
    }

    // Máscara simple para la hora (opcional)
    const timeInput = document.getElementById('id_manual_timestamp');
    if (timeInput) {
        timeInput.addEventListener('input', function(e) {
            let v = this.value.replace(/\D/g,'');
            if (v.length >= 3) v = v.slice(0,2) + ':' + v.slice(2,4);
            this.value = v.slice(0,5);
        });
    }
});
</script>
{% endblock %}