{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Checklist de Turno Interactivo{% endblock %}

{% block content %}
{# --- INICIO: Estilos y Librerías para el Checklist Interactivo --- #}
{# Estas librerías son necesarias para la nueva apariencia. Se cargan desde un CDN para facilidad de uso. #}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Usar la fuente Inter como predeterminada, pero solo dentro de este bloque de contenido */
    .checklist-container {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
    }
    
    /* Estilo personalizado para la transición del tachado */
    .task-label {
        transition: all 0.3s ease-in-out;
        position: relative;
    }
    .task-label::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        width: 0;
        height: 2px;
        background-color: currentColor;
        transition: width 0.3s ease-in-out;
    }
    .task-completed .task-label::after {
        width: 100%;
    }
    
    /* Mejoras para pantallas grandes */
    @media (min-width: 1280px) {
        .phase-column {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .phase-tasks {
            padding-right: 8px;
        }
        
        .phase-tasks::-webkit-scrollbar {
            width: 6px;
        }
        
        .phase-tasks::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .phase-tasks::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .phase-tasks::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    }
    
    /* Animaciones suaves */
    .task-item {
        transform: translateY(0);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .task-item:hover {
        transform: translateY(-2px);
    }
    
    .phase-header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(10px);
    }
</style>
{# --- FIN: Estilos y Librerías --- #}

<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl checklist-container">
    
    <!-- Encabezado -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-700">
            <i class="fas fa-tasks me-2 text-blue-500"></i>Checklist de Tareas del Turno
        </h1>
        {# Usamos la etiqueta 'url' de Django para el enlace de "Volver" #}
        <a href="{% url 'operator_dashboard' %}" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>

    <!-- Contenedor del Checklist en Tres Columnas -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        {# El formulario y el token CSRF son necesarios para enviar los datos de forma segura #}
        <form id="checklist-form" method="post">
            {% csrf_token %}
            
            <!-- Grid de tres columnas -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 lg:gap-6 xl:gap-8 p-4 sm:p-6 lg:p-8">
                
                <!-- Columna 1: Inicio de Turno -->
                <div class="phase-column min-h-[400px]">
                    <div class="phase-header bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500 p-4 mb-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-green-800 flex items-center">
                            <i class="fas fa-play-circle me-2"></i>Inicio de Turno
                        </h3>
                        <p class="text-sm text-green-600 mt-1">Tareas al comenzar el turno</p>
                    </div>
                    <div id="start-tasks" class="phase-tasks">
                        {% for task in tasks_by_phase.start %}
                            <div class="task-item p-4 border rounded-lg mb-3 transition-all duration-300 hover:shadow-md {% if task.completed %}bg-green-50 border-green-200{% else %}bg-white border-gray-200 hover:border-gray-300{% endif %}" data-task-id="{{ task.id }}">
                                <div class="flex items-start">
                                    <input class="form-check-input h-6 w-6 mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" 
                                           type="checkbox" 
                                           name="items"
                                           value="{{ task.id }}" 
                                           id="item_{{ task.id }}"
                                           {% if task.completed %}checked disabled{% endif %}>
                                    <div class="ml-4 flex-grow">
                                        <label class="task-label text-lg font-medium {% if task.completed %}text-gray-400 task-completed{% else %}text-gray-800{% endif %}" 
                                               for="item_{{ task.id }}">
                                            {{ task.description }}
                                        </label>
                                        <div class="mt-2">
                                            <input type="text" 
                                                   name="observacion_{{ task.id }}" 
                                                   class="observation-input form-control w-full px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition" 
                                                   placeholder="Añadir observación (opcional)..." 
                                                   value="{{ task.observation }}"
                                                   {% if task.completed %}readonly{% endif %}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center p-6 text-gray-500">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <p>No hay tareas de inicio</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Columna 2: Durante el Turno -->
                <div class="phase-column min-h-[400px]">
                    <div class="phase-header bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-500 p-4 mb-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-blue-800 flex items-center">
                            <i class="fas fa-clock me-2"></i>Durante el Turno
                        </h3>
                        <p class="text-sm text-blue-600 mt-1">Tareas continuas del turno</p>
                    </div>
                    <div id="during-tasks" class="phase-tasks">
                        {% for task in tasks_by_phase.during %}
                            <div class="task-item p-4 border rounded-lg mb-3 transition-all duration-300 hover:shadow-md {% if task.completed %}bg-green-50 border-green-200{% else %}bg-white border-gray-200 hover:border-gray-300{% endif %}" data-task-id="{{ task.id }}">
                                <div class="flex items-start">
                                    <input class="form-check-input h-6 w-6 mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" 
                                           type="checkbox" 
                                           name="items"
                                           value="{{ task.id }}" 
                                           id="item_{{ task.id }}"
                                           {% if task.completed %}checked disabled{% endif %}>
                                    <div class="ml-4 flex-grow">
                                        <label class="task-label text-lg font-medium {% if task.completed %}text-gray-400 task-completed{% else %}text-gray-800{% endif %}" 
                                               for="item_{{ task.id }}">
                                            {{ task.description }}
                                        </label>
                                        <div class="mt-2">
                                            <input type="text" 
                                                   name="observacion_{{ task.id }}" 
                                                   class="observation-input form-control w-full px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition" 
                                                   placeholder="Añadir observación (opcional)..." 
                                                   value="{{ task.observation }}"
                                                   {% if task.completed %}readonly{% endif %}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center p-6 text-gray-500">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <p>No hay tareas continuas</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Columna 3: Finalización de Turno -->
                <div class="phase-column min-h-[400px] md:col-span-2 xl:col-span-1">
                    <div class="phase-header bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500 p-4 mb-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-red-800 flex items-center">
                            <i class="fas fa-stop-circle me-2"></i>Finalización de Turno
                        </h3>
                        <p class="text-sm text-red-600 mt-1">Tareas al finalizar el turno</p>
                    </div>
                    <div id="end-tasks" class="phase-tasks">
                        {% for task in tasks_by_phase.end %}
                            <div class="task-item p-4 border rounded-lg mb-3 transition-all duration-300 hover:shadow-md {% if task.completed %}bg-green-50 border-green-200{% else %}bg-white border-gray-200 hover:border-gray-300{% endif %}" data-task-id="{{ task.id }}">
                                <div class="flex items-start">
                                    <input class="form-check-input h-6 w-6 mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" 
                                           type="checkbox" 
                                           name="items"
                                           value="{{ task.id }}" 
                                           id="item_{{ task.id }}"
                                           {% if task.completed %}checked disabled{% endif %}>
                                    <div class="ml-4 flex-grow">
                                        <label class="task-label text-lg font-medium {% if task.completed %}text-gray-400 task-completed{% else %}text-gray-800{% endif %}" 
                                               for="item_{{ task.id }}">
                                            {{ task.description }}
                                        </label>
                                        <div class="mt-2">
                                            <input type="text" 
                                                   name="observacion_{{ task.id }}" 
                                                   class="observation-input form-control w-full px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 transition" 
                                                   placeholder="Añadir observación (opcional)..." 
                                                   value="{{ task.observation }}"
                                                   {% if task.completed %}readonly{% endif %}>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-center p-6 text-gray-500">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <p>No hay tareas de finalización</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
            </div>
            
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                <button id="save-button" type="submit" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-save me-2"></i>Guardar Checklist
                </button>
            </div>
        </form>
    </div>

    <!-- Mensaje para cuando no hay tareas -->
    <div id="empty-state" class="text-center p-10 mt-6 bg-white rounded-xl shadow-md" style="display: none;">
        <i class="fas fa-check-double fa-4x text-gray-300 mb-4"></i>
        <h4 class="text-xl font-semibold text-gray-500">No hay tareas para tu turno.</h4>
        <p class="text-gray-400 mt-2">¡Buen trabajo! Parece que todo está en orden.</p>
    </div>

</div>

{# --- INICIO: Lógica JavaScript --- #}
{# Pasamos los datos de Django a JavaScript de forma segura usando la etiqueta json_script #}
{{ tasks_for_js|json_script:"tasks-data" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Obtenemos los datos de las tareas desde el script JSON que Django generó
    const initialTasks = JSON.parse(document.getElementById('tasks-data').textContent);
    
    const emptyState = document.getElementById('empty-state');
    const checklistForm = document.getElementById('checklist-form');
    const phaseContainers = document.querySelectorAll('.phase-tasks');

    // Verificar si hay tareas para mostrar el estado vacío
    if (initialTasks.length === 0) {
        emptyState.style.display = 'block';
        document.querySelector('.bg-white.rounded-xl').style.display = 'none';
    }

    // Manejar el evento de cambio en los checkboxes para la interactividad visual
    phaseContainers.forEach(container => {
        container.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox') {
                const taskWrapper = e.target.closest('.task-item');
                const label = taskWrapper.querySelector('.task-label');
                const observationInput = taskWrapper.querySelector('.observation-input');
                const isChecked = e.target.checked;

                taskWrapper.classList.toggle('bg-green-50', isChecked);
                taskWrapper.classList.toggle('border-green-200', isChecked);
                taskWrapper.classList.toggle('bg-white', !isChecked);
                taskWrapper.classList.toggle('border-gray-200', !isChecked);
                label.classList.toggle('text-gray-400', isChecked);
                label.classList.toggle('text-gray-800', !isChecked);
                label.classList.toggle('task-completed', isChecked);
            }
        });
    });
});
</script>
{# --- FIN: Lógica JavaScript --- #}
{% endblock %}
